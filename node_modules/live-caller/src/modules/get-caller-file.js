import isNode from 'detect-node'
import stackTrace from 'stack-trace'
import fs from 'fs'
import StackTrace from 'stacktrace-js'

const DEFAULT_INDEX = 1

//
// Get callsite info for logging purposes.
// Used to log urls in terminal which will open the IDE with the file open.
//
// We use native Node.js functionality because it supports `source-map-support`.
//

export default function getCallerFile(index = 0) {
  if (isNode) {
    let err = new Error()
    const stack = stackTrace.parse(err)
    const line = stack[DEFAULT_INDEX + index]
    return {
      path: line.getFileName(),
      realpath: fs.realpathSync(line.getFileName()),
      line: line.getLineNumber(),
      col: line.getColumnNumber(),
    }
  } else {
    // TODO(vjpr): Implement for browser. stackinfo is buggy. Use stacktrace.js.
    //return stackinfo()[INDEX]
    const stack = StackTrace.getSync()
    const line = stack[DEFAULT_INDEX + index]
    return {
      path: line.getFileName(),
      line: line.getLineNumber(),
      col: line.getColumnNumber(),
    }
  }
}
